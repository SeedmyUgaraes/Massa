# Техническое задание

WinForms‑приложение для отображения массы с весов Massa-K на OSD видеокамер Hikvision с поддержкой нескольких камер, конфигураторов весов и трендов взвешивания.

## 1. Общие сведения
- Цель: опрашивать несколько весовых терминалов Massa-K по протоколу 100, отображать данные в UI и выводить массу на OSD камер Hikvision через ISAPI.
- Исходные материалы: консольная C#‑утилита (опрос весов + отправка OSD), PDF по протоколу 100.
- Требования: перенести логику в WinForms, сохранить протокольную совместимость, выделить отдельные классы (веса, камеры, история и т. д.).

## 2. Функциональные требования
### 2.1. Сущности
- **Вес (Scale):** IP, порт, имя, вариант протокола (авто), состояние (Net, Tare, Stable, NetFlag, ZeroFlag, LastUpdate, Online).
- **Камера (Camera):** IP, HTTP‑порт (при необходимости), логин/пароль, канал (1), базовые координаты OSD (X/Y/шаг), список привязанных весов.
- **Привязка CameraScaleBinding:** ссылка на вес/камеру, OverlayId, координаты X/Y или авто, флаг «выводить на OSD». Один вес может быть привязан к нескольким камерам.

### 2.2. Подключение к весам
- Параметры: IP, порт, имя, вариант протокола (авто по первому ответу).
- TCP‑соединение на каждый вес: timeout подключения 3 с, повторное подключение через 5 с.
- Опрос: команда CMD_GET_MASSA (0x23) каждые 200 мс, timeout ответа 2 с.
- Ошибки: закрытие соединения, статус Offline при отсутствии данных >10 с, повторное подключение через ReconnectDelay.
- Опрос и сети не блокируют UI; обновления транслируются в UI, историю и формирование OSD.

### 2.3. Протокол 100 Massa-K
- Запрос CMD_GET_MASSA: заголовок `F8 55 CE`, поле Len (Int16 LE), команда 0x23, CRC16‑CCITT (poly 0x1021, seed 0xFFFF) по команде и полезной части.
- Ответ CMD_ACK_MASSA (0x24), заголовок и Len, два варианта полезной части:
  - **WithTare (Len=13):** Command, Weight(Int32), Division(byte), Stable(byte), NetFlag(byte), ZeroFlag(byte), Tare(Int32).
  - **WithoutTare (Len=9):** Command, Weight(Int32), Division, Stable, NetFlag, ZeroFlag.
- CRC16 на ответ обязателен; проверка заголовка, команды, длины.
- Определение варианта: первый корректный ответ — Len>=13 ⇒ WithTare, иначе WithoutTare; сохранить и показывать в UI.
- Пересчёты: Weight/Tare * factor по Division (пример: 0→0.1 г, 1→1 г, 2→10 г, 3→100 г, 4→1 кг). Итог: Net, Tare, Stable, NetFlag, ZeroFlag, время получения.

### 2.4. Работа с камерами Hikvision
- ISAPI PUT `http://{CAM_IP}/ISAPI/System/Video/inputs/channels/1/overlays/text/{overlayId}` с Basic Auth.
- XML тела:
  ```xml
  <TextOverlay>
    <id>OverlayId</id>
    <enabled>true</enabled>
    <positionX>X</positionX>
    <positionY>Y</positionY>
    <displayText>...</displayText>
    <directAngle/>
  </TextOverlay>
  ```
- Формат текста по умолчанию: онлайн — `N:0.123 kg T:0.010 kg [OK]`; офлайн — `Scale Offline`.
- Частота обновления OSD: не чаще 1 раз в 500 мс (параметр). Ошибки HTTP логируются и отражаются в UI; можно выключить OSD для привязки.

### 2.5. Многокамерный режим
- Несколько камер, каждая — вкладка TabControl (заголовок = имя/IP).
- На вкладке камеры: настройки камеры (IP, логин, пароль, проверка), таблица привязанных весов (OSD‑параметры), кнопки добавления/удаления/переименования/проверки.
- Камеры и привязки сохраняются в конфиге и загружаются при старте.

### 2.6. Конфигуратор весов на вкладке камеры
- Таблица «Весы этой камеры»: имя, IP/порт, Net/Tare/Stable/Online (RO), OverlayId, X/Y или auto, флаг «OSD включён».
- Управление: привязать существующий вес, создать новый вес, отвязать вес. Один физический вес опрашивается один раз и шарит состояние во все привязанные камеры.

### 2.7. История и тренды
- Буфер истории per вес: Net, Tare, Stable, время; минимум 60 мин (настраиваемо 10/30/60/120). Старые точки удаляются по времени.
- Запись точек по каждому обновлению (можно ограничить частотой).
- Окно тренда: график Net и Tare по времени, индикатор Stable, выбор интервала (5/10/30 мин, вся история), автообновление, кнопка «Обновить». Открытие по двойному клику/кнопке, окна немодальные.

## 3. Пользовательский интерфейс
- Основное окно: TabControl с вкладками «Весы», «Камеры» (с вложенными вкладками камер), «Настройки», «Лог»; StatusStrip (статус, ошибки, время цикла).
- Вкладка «Камеры»: настройки камеры, таблица весов, кнопки привязки/создания/отвязки, кнопка «График» (опционально).
- Вкладка «Весы»: список всех весов с протоколом, состоянием, списком камер, управление добавлением/редактированием/удалением, запуск/остановка опроса, кнопка «График».
- Вкладка «Настройки»: глобальные интервалы опроса/OSD, таймауты, порог Offline, параметры истории, логирование.
- Вкладка «Лог»: список событий с временем/уровнем/источником, фильтры, очистка, открытие файла логов.
- Окно тренда: заголовок с именем/IP веса, график с Net/Tare/Stable, выбор интервала, автообновление, сохранение истории между открытиями.

## 4. Нефункциональные требования
- Платформа: C#, WinForms, .NET 6 (предпочтительно) или .NET Framework 4.8; Windows 10/11 x64.
- Производительность: до 10 весов и 5 камер при опросе 200 мс и OSD 500 мс без лагов UI.
- Надёжность: сетевые ошибки не рушат приложение; веса/камеры помечаются Offline, автопереподключение.
- Локализация: интерфейс на русском, строки желательно в ресурсах.

## 5. Архитектура и реализация
- Предпочтительные классы: `MassaKClient` (TCP, протокол 100), `HikvisionOsdClient` (XML/HTTP), `ScaleManager`, `CameraManager`, `WeightHistoryManager`. UI‑формы минимально логики.
- Конфиг: JSON со списком весов, камер, привязок и общими настройками; загрузка при старте, сохранение при изменениях.
- Логирование: NLog/Serilog или простой класс; вывод в файл и на вкладку «Лог» (ротация по размеру/дате — по согласованию).
- Тестируемость: вынести логику протокола (пакеты, парсинг, CRC) для unit‑тестов.
